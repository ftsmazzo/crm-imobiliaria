generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Usuario {
  id           String    @id @default(uuid())
  email        String    @unique
  senhaHash    String    @map("senha_hash")
  nome         String
  role         String    @default("corretor")
  ativo        Boolean   @default(true)
  criadoEm     DateTime  @default(now()) @map("criado_em")
  atualizadoEm DateTime  @updatedAt @map("atualizado_em")
  contatos     Contato[]
  imoveis      Imovel[]
  tarefas      Tarefa[]
}

model Contato {
  id                       String    @id @default(uuid())
  nome                     String
  email                    String
  telefone                 String?
  origem                   String?
  observacoes              String?   @map("observacoes")
  estagio                  String    @default("novo") // novo, qualificado, visita, proposta, fechado
  usuarioResponsavelId     String?   @map("usuario_responsavel_id")
  criadoEm                 DateTime  @default(now()) @map("criado_em")
  atualizadoEm             DateTime  @updatedAt @map("atualizado_em")
  usuarioResponsavel       Usuario?  @relation(fields: [usuarioResponsavelId], references: [id])
  interesses               Interesse[]
  tarefas                  Tarefa[]
  imoveisComoProprietario  Imovel[]  @relation("ProprietarioImoveis")
}

model Empreendimento {
  id          String   @id @default(uuid())
  nome        String
  descricao   String?  @db.Text
  endereco    String?  @map("endereco") @db.Text
  criadoEm    DateTime @default(now()) @map("criado_em")
  atualizadoEm DateTime @updatedAt @map("atualizado_em")
  imoveis     Imovel[]

  @@map("empreendimento")
}

model Imovel {
  id                    String    @id @default(uuid())
  tipo                  String    // casa, apartamento, terreno, casa_condominio, terreno_condominio, comercial
  rua                   String?
  numero                String?
  bairro                String?
  cidade                String?
  cep                   String?
  valorVenda            Decimal?  @map("valor_venda") @db.Decimal(14, 2)
  valorAluguel          Decimal?  @map("valor_aluguel") @db.Decimal(14, 2)
  valorIptu             Decimal?  @map("valor_iptu") @db.Decimal(14, 2)
  valorCondominio       Decimal?  @map("valor_condominio") @db.Decimal(14, 2)
  status                String    @default("disponivel") // disponivel, reservado, vendido, alugado
  codigo                String?
  quadra                String?
  lote                  String?
  descricao             String?   @db.Text
  qtdQuartos            Int?      @map("qtd_quartos")
  qtdBanheiros          Int?      @map("qtd_banheiros")
  qtdSalas              Int?      @map("qtd_salas")
  lavabo                Int?      @default(0) // 0 = não, 1+ = quantidade
  area                  Decimal?  @db.Decimal(10, 2)   // área construída m²
  areaTerreno           Decimal?  @map("area_terreno") @db.Decimal(10, 2)
  anoConstrucao         Int?      @map("ano_construcao")
  tipoPiso              String?   @map("tipo_piso")
  empreendimentoId      String?   @map("empreendimento_id")
  proprietarioId        String?   @map("proprietario_id")
  usuarioResponsavelId  String?   @map("usuario_responsavel_id")
  criadoEm              DateTime  @default(now()) @map("criado_em")
  atualizadoEm          DateTime  @updatedAt @map("atualizado_em")
  usuarioResponsavel    Usuario?  @relation(fields: [usuarioResponsavelId], references: [id])
  empreendimento        Empreendimento? @relation(fields: [empreendimentoId], references: [id], onDelete: SetNull)
  proprietario          Contato?  @relation("ProprietarioImoveis", fields: [proprietarioId], references: [id], onDelete: SetNull)
  fotos                 ImovelFoto[]
  documentos            ImovelDocumento[]
  interesses            Interesse[]
  tarefas               Tarefa[]
}

model ImovelDocumento {
  id        String   @id @default(uuid())
  imovelId  String   @map("imovel_id")
  tipo      String   // iptu, autorizacao
  key       String   // objeto no storage (ex: imoveis/uuid/documentos/nome.pdf)
  nome      String?  // nome original do arquivo
  criadoEm  DateTime @default(now()) @map("criado_em")
  imovel    Imovel   @relation(fields: [imovelId], references: [id], onDelete: Cascade)

  @@map("imovel_documento")
}

model ImovelFoto {
  id        String   @id @default(uuid())
  imovelId  String   @map("imovel_id")
  key       String   // objeto no MinIO (ex: imoveis/uuid/nome-arquivo.jpg)
  ordem     Int      @default(0)
  criadoEm  DateTime @default(now()) @map("criado_em")
  imovel    Imovel   @relation(fields: [imovelId], references: [id], onDelete: Cascade)

  @@map("imovel_foto")
}

model Tarefa {
  id           String    @id @default(uuid())
  titulo       String
  descricao    String?
  dataPrevista DateTime? @map("data_prevista") @db.Date
  concluida    Boolean   @default(false)
  usuarioId    String    @map("usuario_id")
  contatoId    String?   @map("contato_id")
  imovelId     String?   @map("imovel_id")
  criadoEm     DateTime  @default(now()) @map("criado_em")
  usuario     Usuario   @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  contato     Contato?  @relation(fields: [contatoId], references: [id], onDelete: SetNull)
  imovel      Imovel?   @relation(fields: [imovelId], references: [id], onDelete: SetNull)
}

model Interesse {
  id        String   @id @default(uuid())
  tipo      String   @default("interesse") // interesse, proposta
  valor     Decimal? @db.Decimal(14, 2)
  status    String?  // enviada, aceita, recusada
  observacao String?
  contatoId String   @map("contato_id")
  imovelId  String   @map("imovel_id")
  criadoEm  DateTime @default(now()) @map("criado_em")
  contato   Contato  @relation(fields: [contatoId], references: [id], onDelete: Cascade)
  imovel    Imovel   @relation(fields: [imovelId], references: [id], onDelete: Cascade)
}
